<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Solve intelligence, use it to make the world a better place."><title>Caffe 入门-MNIST 实验 | 项脊轩</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-74386502-3','auto');ga('send','pageview');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Caffe 入门-MNIST 实验</h1><a id="logo" href="/.">项脊轩</a><p class="description">项脊轩，旧南阁子也</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/books/"><i class="fa fa-book"> 书单</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/history/"><i class="fa fa-history"> 历史</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Caffe 入门-MNIST 实验</h1><div class="post-meta">Apr 25, 2017<span> | </span><span class="category"><a href="/categories/深度学习/">深度学习</a></span><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a data-disqus-identifier="2017/04/25/how-to-do-mnist-demo/" href="/2017/04/25/how-to-do-mnist-demo/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#数据集准备"><span class="toc-number">1.</span> <span class="toc-text">数据集准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#下载数据集"><span class="toc-number">1.1.</span> <span class="toc-text">下载数据集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据存储格式"><span class="toc-number">1.2.</span> <span class="toc-text">数据存储格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#可视化MNIST-数据集"><span class="toc-number">1.3.</span> <span class="toc-text">可视化MNIST 数据集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#转化为lmdb-格式"><span class="toc-number">1.4.</span> <span class="toc-text">转化为lmdb 格式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定义MNIST-网络"><span class="toc-number">2.</span> <span class="toc-text">定义MNIST 网络</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#可视化网络"><span class="toc-number">2.1.</span> <span class="toc-text">可视化网络</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#训练"><span class="toc-number">3.</span> <span class="toc-text">训练</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#预测一张新的图片"><span class="toc-number">4.</span> <span class="toc-text">预测一张新的图片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="post-content"><p>MNIST 是一个包含各种手写数字（0-9）图片(images)和对应标签(label)的数据集，下面我们将介绍如何利用 <a href="https://github.com/bvlc/caffe/" target="_blank" rel="noopener">Caffe</a>框架对手写数字识别一个完整的流程，本实验代码可以<a href="https://github.com/mindcont/caffe/blob/master/examples/mnist" target="_blank" rel="noopener">github</a>下载。</p>
<a id="more"></a>
<p><img src="/images/research/caffe/asamples.gif" alt=""></p>
<h2 id="数据集准备"><a href="#数据集准备" class="headerlink" title="数据集准备"></a>数据集准备</h2><h3 id="下载数据集"><a href="#下载数据集" class="headerlink" title="下载数据集"></a>下载数据集</h3><p>You will first need to download and convert the data format from the MNIST website. To do this, simply run the following commands:</p>
<p>We will assume that you have Caffe successfully compiled. If not, please refer to the <a href="">Installation page</a>. In this tutorial, we will assume that your Caffe installation is located at CAFFE_ROOT.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$CAFFE_ROOT</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载数据集并解压</span></span><br><span class="line">./data/mnist/get_mnist.sh</span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pi<span class="meta">@DEEPMIND</span>:~/caffe$ ./data/mnist/get_mnist.sh</span><br><span class="line">Downloading...</span><br><span class="line">--<span class="number">2017</span>-<span class="number">04</span>-<span class="number">24</span> <span class="number">09</span>:<span class="number">59</span>:<span class="number">12</span>--  http:<span class="comment">//yann.lecun.com/exdb/mnist/train-images-idx3-ubyte.gz</span></span><br><span class="line">正在解析主机 yann.lecun.com (yann.lecun.com)... <span class="number">216.165</span>.22.6</span><br><span class="line">正在连接 yann.lecun.com (yann.lecun.com)|<span class="number">216.165</span>.22.6|:<span class="number">80</span>... 已连接。</span><br><span class="line">已发出 HTTP 请求，正在等待回应... <span class="number">302</span> Found</span><br><span class="line">位置：http:<span class="comment">//10.10.10.50/files/4107000000008DA0/yann.lecun.com/exdb/mnist/train-images-idx3-ubyte.gz [跟随至新的 URL]</span></span><br><span class="line">--<span class="number">2017</span>-<span class="number">04</span>-<span class="number">24</span> <span class="number">09</span>:<span class="number">59</span>:<span class="number">17</span>--  http:<span class="comment">//10.10.10.50/files/4107000000008DA0/yann.lecun.com/exdb/mnist/train-images-idx3-ubyte.gz</span></span><br><span class="line">正在连接 <span class="number">10.10</span>.10.50:<span class="number">80</span>... 已连接。</span><br><span class="line">已发出 HTTP 请求，正在等待回应... <span class="number">200</span> OK</span><br><span class="line">长度： <span class="number">9912422</span> (<span class="number">9.5</span>M) [application/octet-stream]</span><br><span class="line">正在保存至: “train-images-idx3-ubyte.gz”</span><br><span class="line"></span><br><span class="line"><span class="number">100</span>%[======================================&gt;] <span class="number">9</span>,<span class="number">912</span>,<span class="number">422</span>    <span class="number">479</span>KB/s   用时 <span class="number">20</span>s  </span><br><span class="line"></span><br><span class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">24</span> <span class="number">09</span>:<span class="number">59</span>:<span class="number">37</span> (<span class="number">485</span> KB/s) - 已保存 “train-images-idx3-ubyte.gz” [<span class="number">9912422</span>/<span class="number">9912422</span>])</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">长度： <span class="number">4542</span> (<span class="number">4.4</span>K) [application/x-gzip]</span><br><span class="line">正在保存至: “t10k-labels-idx1-ubyte.gz”</span><br><span class="line"></span><br><span class="line"><span class="number">100</span>%[======================================&gt;] <span class="number">4</span>,<span class="number">542</span>       --.-K/s   用时 <span class="number">0.001</span>s</span><br><span class="line"></span><br><span class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">24</span> <span class="number">09</span>:<span class="number">59</span>:<span class="number">44</span> (<span class="number">7.86</span> MB/s) - 已保存 “t10k-labels-idx1-ubyte.gz” [<span class="number">4542</span>/<span class="number">4542</span>])</span><br></pre></td></tr></table></figure>
<h3 id="数据存储格式"><a href="#数据存储格式" class="headerlink" title="数据存储格式"></a>数据存储格式</h3><p>There are 4 files:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">训练集</span><br><span class="line">train-images-idx3-ubyte: training <span class="built_in">set</span> images</span><br><span class="line">train-labels-idx1-ubyte: training <span class="built_in">set</span> labels</span><br><span class="line"></span><br><span class="line">验证集</span><br><span class="line">t10k-images-idx3-ubyte:  <span class="built_in">test</span> <span class="built_in">set</span> images</span><br><span class="line">t10k-labels-idx1-ubyte:  <span class="built_in">test</span> <span class="built_in">set</span> labels</span><br></pre></td></tr></table></figure></p>
<p>The training set contains 60000 examples, and the test set 10000 examples.</p>
<p>The first 5000 examples of the test set are taken from the original NIST training set. The last 5000 are taken from the original NIST test set. The first 5000 are cleaner and easier than the last 5000.</p>
<p>对于每个文件的存储格式，以train-images-idx3-ubyte 训练集图片：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">TRAINING SET IMAGE FILE (train-images-idx3-ubyte):</span><br><span class="line">[offset] [type]          [value]          [description]</span><br><span class="line">0000     32 bit integer  0x00000803(2051) magic number</span><br><span class="line">0004     32 bit integer  60000            number of images</span><br><span class="line">0008     32 bit integer  28               number of rows</span><br><span class="line">0012     32 bit integer  28               number of columns</span><br><span class="line">0016     unsigned byte   ??               pixel</span><br><span class="line">0017     unsigned byte   ??               pixel</span><br><span class="line">........</span><br><span class="line">xxxx     unsigned byte   ??               pixel</span><br><span class="line"></span><br><span class="line">Pixels are organized row-wise. Pixel values are 0 to 255. 0 means background (white), 255 means foreground (black).</span><br></pre></td></tr></table></figure></p>
<p>头部信息存储 整个文件信息（magic_number,number of images,image_width,image_hight），按字节偏移地址依次存储 每个像素的信息，对于单副图片我们要依次遍历28*28个像素，更多参见<a href="http://yann.lecun.com/exdb/mnist/" target="_blank" rel="noopener">mnist</a> 。</p>
<h3 id="可视化MNIST-数据集"><a href="#可视化MNIST-数据集" class="headerlink" title="可视化MNIST 数据集"></a>可视化MNIST 数据集</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/mnist</span><br><span class="line">mkdir train</span><br><span class="line">python visual_mnist_data.py</span><br></pre></td></tr></table></figure>
<p>从 <code>data/mnist/train/</code>下，我们可以看到刚才将 rain-images-idx3-ubyte 提取出来的训练集图像，可以看到训练集中单个图片是28*28 单通道灰度图像，如下图所示</p>
<p><img src="/images/research/caffe/0.png" alt=""></p>
<p>标签文件按图片名称顺序代表图片中数字。如 <code>0.png</code> 对应label.txt 第一个字符 5。</p>
<h3 id="转化为lmdb-格式"><a href="#转化为lmdb-格式" class="headerlink" title="转化为lmdb 格式"></a>转化为lmdb 格式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./examples/mnist/create_mnist.sh</span><br></pre></td></tr></table></figure>
<p>输出结果<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pi<span class="meta">@DEEPMIND</span>:~/caffe$ ./examples/mnist/create_mnist.sh</span><br><span class="line">Creating lmdb...</span><br><span class="line">I0424 <span class="number">10</span>:<span class="number">03</span>:<span class="number">11.133980</span>  <span class="number">2966</span> db_lmdb.cpp:<span class="number">35</span>] Opened lmdb examples/mnist/mnist_train_lmdb</span><br><span class="line">I0424 <span class="number">10</span>:<span class="number">03</span>:<span class="number">11.134397</span>  <span class="number">2966</span> convert_mnist_data.cpp:<span class="number">88</span>] A total of <span class="number">60000</span> items.</span><br><span class="line">I0424 <span class="number">10</span>:<span class="number">03</span>:<span class="number">11.134409</span>  <span class="number">2966</span> convert_mnist_data.cpp:<span class="number">89</span>] Rows: <span class="number">28</span> Cols: <span class="number">28</span></span><br><span class="line">I0424 <span class="number">10</span>:<span class="number">03</span>:<span class="number">15.408113</span>  <span class="number">2966</span> convert_mnist_data.cpp:<span class="number">108</span>] Processed <span class="number">60000</span> files.</span><br><span class="line">I0424 <span class="number">10</span>:<span class="number">03</span>:<span class="number">15.553190</span>  <span class="number">2969</span> db_lmdb.cpp:<span class="number">35</span>] Opened lmdb examples/mnist/mnist_test_lmdb</span><br><span class="line">I0424 <span class="number">10</span>:<span class="number">03</span>:<span class="number">15.553597</span>  <span class="number">2969</span> convert_mnist_data.cpp:<span class="number">88</span>] A total of <span class="number">10000</span> items.</span><br><span class="line">I0424 <span class="number">10</span>:<span class="number">03</span>:<span class="number">15.553642</span>  <span class="number">2969</span> convert_mnist_data.cpp:<span class="number">89</span>] Rows: <span class="number">28</span> Cols: <span class="number">28</span></span><br><span class="line">I0424 <span class="number">10</span>:<span class="number">03</span>:<span class="number">16.184403</span>  <span class="number">2969</span> convert_mnist_data.cpp:<span class="number">108</span>] Processed <span class="number">10000</span> files.</span><br><span class="line">Done.</span><br></pre></td></tr></table></figure></p>
<h2 id="定义MNIST-网络"><a href="#定义MNIST-网络" class="headerlink" title="定义MNIST 网络"></a>定义MNIST 网络</h2><p>这一部分，官方教程比较好，移步<a href="https://github.com/bvlc/caffe/blob/master/examples/mnist/readme.md" target="_blank" rel="noopener">Training LeNet on MNIST with Caffe</a>。<br>值得注意的是：本本所使用的LeNet模型 ，和原始的有所不同，我们使用Relu 代替 sigmoid,在<code>examples/mnist/lenet_train_test.prototxt</code>下。</p>
<h3 id="可视化网络"><a href="#可视化网络" class="headerlink" title="可视化网络"></a>可视化网络</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span>  examples/mnist/trian</span><br><span class="line">bash ./vis_net.sh</span><br></pre></td></tr></table></figure>
<p>训练网络<br><img src="/images/research/caffe/lenet_train_test.png" alt=""></p>
<p>测试／部署网络，即用于测试，和训练网络区别在于没有标签的输入，只有前向传播过程。<br><img src="/images/research/caffe/lenet.png" alt=""></p>
<h2 id="训练"><a href="#训练" class="headerlink" title="训练"></a>训练</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /examples/mnist/train</span><br><span class="line">./</span><br><span class="line">./train_lenet.sh</span><br></pre></td></tr></table></figure>
<p>其中<code>train_lenet.sh</code>内容如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env sh</span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">log_path=<span class="string">"logs/"</span></span><br><span class="line">mkdir -p $log_path</span><br><span class="line"></span><br><span class="line">save_model_path=<span class="string">"caffemodel/"</span></span><br><span class="line">mkdir -p $save_model_path</span><br><span class="line"></span><br><span class="line"># training log</span><br><span class="line">file_prefix=<span class="string">"mnist_"</span></span><br><span class="line">log_file=$(date -d <span class="string">"today"</span> +<span class="string">"%Y-%m-%d-%H:%M:%S"</span>)</span><br><span class="line">log_file=$log_path$file_prefix$log_file<span class="string">".log"</span></span><br><span class="line"></span><br><span class="line"># caffe execute file path</span><br><span class="line">caffe_bin=<span class="string">"../../../build/tools/caffe"</span></span><br><span class="line"></span><br><span class="line">$caffe_bin train --solver=lenet_solver.prototxt  <span class="number">2</span>&gt;&amp;<span class="number">1</span>  | tee -a $log_file</span><br></pre></td></tr></table></figure></p>
<p>观察训练日志输出，保存在<code>logs/</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">I0424 <span class="number">11</span>:<span class="number">10</span>:<span class="number">01.759721</span>  <span class="number">4049</span> caffe.cpp:<span class="number">211</span>] Use CPU.</span><br><span class="line">I0424 <span class="number">11</span>:<span class="number">10</span>:<span class="number">01.785264</span>  <span class="number">4049</span> solver.cpp:<span class="number">44</span>] Initializing solver from parameters:</span><br><span class="line">test_iter: <span class="number">100</span></span><br><span class="line">test_interval: <span class="number">500</span></span><br><span class="line">base_lr: <span class="number">0.01</span></span><br><span class="line">display: <span class="number">100</span></span><br><span class="line">max_iter: <span class="number">10000</span></span><br><span class="line">lr_policy: <span class="string">"inv"</span></span><br><span class="line">gamma: <span class="number">0.0001</span></span><br><span class="line">power: <span class="number">0.75</span></span><br><span class="line">momentum: <span class="number">0.9</span></span><br><span class="line">weight_decay: <span class="number">0.0005</span></span><br><span class="line">snapshot: <span class="number">5000</span></span><br><span class="line">snapshot_prefix: <span class="string">"caffemodel/lenet"</span></span><br><span class="line">solver_mode: CPU</span><br><span class="line">net: <span class="string">"lenet_train_test.prototxt"</span></span><br><span class="line">train_state &#123;</span><br><span class="line">  level: <span class="number">0</span></span><br><span class="line">  stage: <span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line">I0424 <span class="number">11</span>:<span class="number">10</span>:<span class="number">01.785367</span>  <span class="number">4049</span> solver.cpp:<span class="number">87</span>] Creating training net from net file: lenet_train_test.prototxt</span><br><span class="line">I0424 <span class="number">11</span>:<span class="number">10</span>:<span class="number">01.785703</span>  <span class="number">4049</span> net.cpp:<span class="number">294</span>] <span class="function">The NetState <span class="title">phase</span> <span class="params">(<span class="number">0</span>)</span> differed from the <span class="title">phase</span> <span class="params">(<span class="number">1</span>)</span> specified by a rule in layer mnist</span></span><br><span class="line"><span class="function">I0424 11:10:01.785719  4049 net.cpp:294] The NetState <span class="title">phase</span> <span class="params">(<span class="number">0</span>)</span> differed from the <span class="title">phase</span> <span class="params">(<span class="number">1</span>)</span> specified by a rule in layer accuracy</span></span><br><span class="line"><span class="function">I0424 11:10:01.785794  4049 net.cpp:51] Initializing net from parameters:</span></span><br><span class="line"><span class="function">name: "LeNet"</span></span><br><span class="line"><span class="function">state </span>&#123;</span><br><span class="line">  phase: TRAIN</span><br><span class="line">  level: <span class="number">0</span></span><br><span class="line">  stage: <span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line">layer &#123;</span><br><span class="line">  name: <span class="string">"mnist"</span></span><br><span class="line">  type: <span class="string">"Data"</span></span><br><span class="line">  top: <span class="string">"data"</span></span><br><span class="line">  top: <span class="string">"label"</span></span><br><span class="line">  include &#123;</span><br><span class="line">    phase: TRAIN</span><br><span class="line">  &#125;</span><br><span class="line">  transform_param &#123;</span><br><span class="line">    scale: <span class="number">0.00390625</span></span><br><span class="line">  &#125;</span><br><span class="line">  data_param &#123;</span><br><span class="line">    source: <span class="string">"../mnist_train_lmdb"</span></span><br><span class="line">    batch_size: <span class="number">64</span></span><br><span class="line">    backend: LMDB</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line"></span><br><span class="line">I0424 <span class="number">11</span>:<span class="number">22</span>:<span class="number">48.831621</span>  <span class="number">4049</span> solver.cpp:<span class="number">218</span>] Iteration <span class="number">9900</span> (<span class="number">14.7601</span> iter/s, <span class="number">6.775</span>s/<span class="number">100</span> iters), loss = <span class="number">0.00511876</span></span><br><span class="line">I0424 11:22:48.831665  4049 solver.cpp:237]     Train net output #0: loss = 0.00511864 (* 1 = 0.00511864 loss)</span><br><span class="line">I0424 <span class="number">11</span>:<span class="number">22</span>:<span class="number">48.831676</span>  <span class="number">4049</span> sgd_solver.cpp:<span class="number">105</span>] Iteration <span class="number">9900</span>, lr = <span class="number">0.00596843</span></span><br><span class="line">I0424 <span class="number">11</span>:<span class="number">22</span>:<span class="number">55.538620</span>  <span class="number">4049</span> solver.cpp:<span class="number">447</span>] Snapshotting to binary proto file caffemodel/lenet_iter_10000.caffemodel</span><br><span class="line">I0424 <span class="number">11</span>:<span class="number">22</span>:<span class="number">55.543390</span>  <span class="number">4049</span> sgd_solver.cpp:<span class="number">273</span>] Snapshotting solver state to binary proto file caffemodel/lenet_iter_10000.solverstate</span><br><span class="line">I0424 <span class="number">11</span>:<span class="number">22</span>:<span class="number">55.578083</span>  <span class="number">4049</span> solver.cpp:<span class="number">310</span>] Iteration <span class="number">10000</span>, loss = <span class="number">0.00350995</span></span><br><span class="line">I0424 <span class="number">11</span>:<span class="number">22</span>:<span class="number">55.578119</span>  <span class="number">4049</span> solver.cpp:<span class="number">330</span>] Iteration <span class="number">10000</span>, <span class="function">Testing <span class="title">net</span> <span class="params">(#<span class="number">0</span>)</span></span></span><br><span class="line"><span class="function">I0424 11:22:59.965965  4054 data_layer.cpp:73] Restarting data prefetching from start.</span></span><br><span class="line"><span class="function">I0424 11:23:00.153450  4049 solver.cpp:397]     Test net output #0: accuracy </span>= <span class="number">0.9912</span></span><br><span class="line">I0424 11:23:00.153553  4049 solver.cpp:397]     Test net output #1: loss = 0.0277065 (* 1 = 0.0277065 loss)</span><br><span class="line">I0424 <span class="number">11</span>:<span class="number">23</span>:<span class="number">00.153568</span>  <span class="number">4049</span> solver.cpp:<span class="number">315</span>] Optimization Done.</span><br><span class="line">I0424 <span class="number">11</span>:<span class="number">23</span>:<span class="number">00.153573</span>  <span class="number">4049</span> caffe.cpp:<span class="number">259</span>] Optimization Done.</span><br></pre></td></tr></table></figure></p>
<p>至此，我们就完成了利用Lenet 网络模型在mnist数据集上进行训练，如何评价训练结果呢？我们可以输入一张新的图片，使用刚才训练的模型进行预测，来评价我们训练结果的好坏。</p>
<h2 id="预测一张新的图片"><a href="#预测一张新的图片" class="headerlink" title="预测一张新的图片"></a>预测一张新的图片</h2><p>假设待预测图片为下图<br><img src="/images/research/caffe/2.png" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> examples/mnist/<span class="built_in">test</span></span><br><span class="line">python mnist_test.py 2.png</span><br></pre></td></tr></table></figure>
<p>输出<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">pi<span class="meta">@DEEPMIND</span>:~/caffe/examples/mnist/test$ python mnist_test.py test.jpg</span><br><span class="line">WARNING: <span class="function">Logging before <span class="title">InitGoogleLogging</span><span class="params">()</span> is written to STDERR</span></span><br><span class="line"><span class="function">W0424 14:23:46.789387  6313 _caffe.cpp:139] DEPRECATION WARNING - deprecated use of Python interface</span></span><br><span class="line"><span class="function">W0424 14:23:46.789423  6313 _caffe.cpp:140] Use <span class="keyword">this</span> <span class="title">instead</span> <span class="params">(with the named <span class="string">"weights"</span> parameter)</span>:</span></span><br><span class="line"><span class="function">W0424 14:23:46.789428  6313 _caffe.cpp:142] <span class="title">Net</span><span class="params">(<span class="string">'../train/lenet.prototxt'</span>, <span class="number">1</span>, weights=<span class="string">'../train/caffemodel/lenet_iter_10000.caffemodel'</span>)</span></span></span><br><span class="line"><span class="function">I0424 14:23:46.883805  6313 net.cpp:51] Initializing net from parameters:</span></span><br><span class="line"><span class="function">name: "LeNet"</span></span><br><span class="line"><span class="function">state </span>&#123;</span><br><span class="line">  phase: TEST</span><br><span class="line">  level: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">layer &#123;</span><br><span class="line">  name: <span class="string">"data"</span></span><br><span class="line">  type: <span class="string">"Input"</span></span><br><span class="line">  top: <span class="string">"data"</span></span><br><span class="line">  input_param &#123;</span><br><span class="line">    shape &#123;</span><br><span class="line">      dim: <span class="number">64</span></span><br><span class="line">      dim: <span class="number">1</span></span><br><span class="line">      dim: <span class="number">28</span></span><br><span class="line">      dim: <span class="number">28</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">layer &#123;</span><br><span class="line">  name: <span class="string">"conv1"</span></span><br><span class="line">  type: <span class="string">"Convolution"</span></span><br><span class="line">  bottom: <span class="string">"data"</span></span><br><span class="line">  top: <span class="string">"conv1"</span></span><br><span class="line">  param &#123;</span><br><span class="line">    lr_mult: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  param &#123;</span><br><span class="line">    lr_mult: <span class="number">2</span></span><br><span class="line">  &#125;</span><br><span class="line">  convolution_param &#123;</span><br><span class="line">    num_output: <span class="number">20</span></span><br><span class="line">    kernel_size: <span class="number">5</span></span><br><span class="line">    stride: <span class="number">1</span></span><br><span class="line">    weight_filler &#123;</span><br><span class="line">      type: <span class="string">"xavier"</span></span><br><span class="line">    &#125;</span><br><span class="line">    bias_filler &#123;</span><br><span class="line">      type: <span class="string">"constant"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line"></span><br><span class="line">I0424 <span class="number">14</span>:<span class="number">41</span>:<span class="number">40.851599</span>  <span class="number">7883</span> net.cpp:<span class="number">242</span>] This network produces output prob</span><br><span class="line">I0424 <span class="number">14</span>:<span class="number">41</span>:<span class="number">40.851608</span>  <span class="number">7883</span> net.cpp:<span class="number">255</span>] Network initialization done.</span><br><span class="line">I0424 <span class="number">14</span>:<span class="number">41</span>:<span class="number">40.854398</span>  <span class="number">7883</span> net.cpp:<span class="number">744</span>] Ignoring source layer mnist</span><br><span class="line">I0424 <span class="number">14</span>:<span class="number">41</span>:<span class="number">40.854982</span>  <span class="number">7883</span> net.cpp:<span class="number">744</span>] Ignoring source layer loss</span><br><span class="line">[  <span class="number">5.44423534e-11</span>   <span class="number">2.36225206e-11</span>   <span class="number">1.00000000e+00</span>   <span class="number">6.40073061e-09</span></span><br><span class="line">   <span class="number">1.00278713e-18</span>   <span class="number">2.31217930e-18</span>   <span class="number">2.05065188e-17</span>   <span class="number">6.41556852e-09</span></span><br><span class="line">   <span class="number">5.65470171e-10</span>   <span class="number">1.42476214e-13</span>]</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到网络输出10分类各自的概率，最后取最大的概率所对应的标签作为预测结果，即<code>2</code>。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过上面的步骤，我们就完成了一个机器学习的通用步骤，即数据集的预处理、训练网络的定义，训练，预测和评估。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://github.com/bvlc/caffe/blob/master/examples/mnist/readme.md" target="_blank" rel="noopener">Training LeNet on MNIST with Caffe</a></li>
<li><a href="http://yann.lecun.com/exdb/lenet/" target="_blank" rel="noopener">MNIST Demos on Yann LeCun’s website</a></li>
</ul>
</div><div class="tags"></div><div class="post-nav"><a href="/2017/09/09/interview-diary/" class="pre">求职笔记</a><a href="/2017/02/25/debug-android-win/" class="next">调试安卓的小技巧</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'micro-era';
var disqus_identifier = '2017/04/25/how-to-do-mnist-demo/';
var disqus_title = 'Caffe 入门-MNIST 实验';
var disqus_url = 'http://blog.mindcont.com/2017/04/25/how-to-do-mnist-demo/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/next/config.json',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//micro-era.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://blog.mindcont.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/深度学习/">深度学习</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/物联/">物联</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔日记/">随笔日记</a><span class="category-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/caffe/" style="font-size: 15px;">caffe</a> <a href="/tags/coding/" style="font-size: 15px;">coding</a> <a href="/tags/openwrt/" style="font-size: 15px;">openwrt</a> <a href="/tags/opencv/" style="font-size: 15px;">opencv</a> <a href="/tags/kinect/" style="font-size: 15px;">kinect</a> <a href="/tags/matlab/" style="font-size: 15px;">matlab</a> <a href="/tags/ros/" style="font-size: 15px;">ros</a> <a href="/tags/树莓派/" style="font-size: 15px;">树莓派</a> <a href="/tags/ubuntu/" style="font-size: 15px;">ubuntu</a> <a href="/tags/随笔日记/" style="font-size: 15px;">随笔日记</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/01/02/my-review-2018/">2018 , 我的年终总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/16/diyprojects-raspbian/">无线IO | 一个开源智能家居解决方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/28/cube-robot/">魔方机器人开箱</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//micro-era.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://memect.com/" title="好东西传送门" target="_blank">好东西传送门</a><ul></ul><a href="https://prism-break.org/zh-CN/all/" title="粉碎棱镜" target="_blank">粉碎棱镜</a><ul></ul><a href="https://www.daoon.com/" title="道卬" target="_blank">道卬</a><ul></ul><a href="https://www.ted.com/" title="TED | 值得传播的思想" target="_blank">TED | 值得传播的思想</a></div><div class="widget"><div class="widget-title"> <i class="fa fa-audio-description"> 推广链接</i></div><br/><a href="https://www.vultr.com/?ref=7173488" target="_black"> <img src="https://www.vultr.com/media/banner_3.png" width="192px"/></a><br/><a href="https://portal.qiniu.com/signup?code=3lc7blnku8d3m" target="_black"><img src="https://www.qiniu.com/assets/logo-b5caafe0363dace7b5c0a00be38a4829444918c4322a6168714522ee19dcb1c1.png" width="192px"/></a><div class="widget-title"> <i class="fa fa-handshake-o"> 智能家居</i></div><a href="http://diy.mindcont.com" target="_black"><img src="/images/iot/diy/diy-site.png" width="160px"/></a></div></div></div><div class="pure-u-1 pure-u-md-3-4"></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>